<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LongTextAgent - åˆ›ä½œä¸»æ§å°</title>
    <!-- CDN Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: #f3f3f3;
            color: #333333;
        }
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        
        /* VS Code Style Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 0px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        textarea {
            resize: none;
        }

        /* -------------------------------------
           Scanner Animation (Hacker Mode)
        -------------------------------------- */
        .scanner-container {
            position: relative;
            background-color: #1e1e1e; /* VS Code æš—è‰²æ¨¡å¼æ¨¡æ‹Ÿ */
            color: #d4d4d4;
            border-radius: 4px;
        }
        .scanner-laser {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #007acc;
            box-shadow: 0 0 12px 3px rgba(0, 122, 204, 0.7);
            animation: scan 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            z-index: 10;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .pulse-text {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Markdown Rendering Defaults */
        .markdown-body {
            line-height: 1.8;
            font-size: 15px;
            color: #24292f;
        }
        .markdown-body h1 {
            font-size: 2em; margin-bottom: 0.8em; font-weight: 600; padding-bottom: 0.3em;
            border-bottom: 1px solid #d0d7de;
        }
        .markdown-body h2 {
            font-size: 1.5em; margin-top: 1.5em; margin-bottom: 0.8em; font-weight: 600;
        }
        .markdown-body p { margin-bottom: 1.2M; }
        .markdown-body strong { font-weight: 600; }
    </style>
</head>
<body class="overflow-hidden">

<div id="app" class="flex h-screen w-full">
    
    <!-- ä¾§è¾¹æ  (Sidebar - Configuration) -->
    <div class="w-[380px] min-w-[380px] bg-[#f8f9fa] border-r border-[#e5e7eb] flex flex-col shadow-sm z-10 shrink-0">
        
        <!-- Header -->
        <div class="h-12 border-b border-[#e5e7eb] bg-white flex items-center justify-between px-4 shrink-0">
            <h1 class="text-xs font-bold text-gray-700 tracking-widest uppercase">âš™ï¸ Long-Text-Agent</h1>
            <span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-0.5 rounded border border-blue-200 uppercase font-mono tracking-wider">v2.0 Core</span>
        </div>
        
        <!-- Form Area -->
        <div class="p-5 flex-1 overflow-y-auto space-y-6 text-[13px] custom-scroll">
            
            <!-- Title -->
            <div class="space-y-1.5">
                <label class="font-semibold text-gray-700 uppercase tracking-widest text-[11px]">PROJECT.TITLE</label>
                <input v-model="title" type="text" 
                       class="w-full border border-gray-300 rounded-sm px-3 py-2 bg-white focus:outline-none focus:border-[#007acc] focus:ring-1 focus:ring-[#007acc] transition-colors" 
                       placeholder="å¦‚ï¼šä¿®ä»™ç•Œæœ€å¼ºé‰´å®å¸ˆ">
            </div>

            <!-- Mode Selection -->
            <div class="space-y-1.5">
                <label class="font-semibold text-gray-700 uppercase tracking-widest text-[11px]">ENGINE.MODE</label>
                <div class="grid grid-cols-2 gap-2">
                    <button v-for="m in modes" :key="m.id" 
                            @click="mode = m.id"
                            :class="['px-3 py-2 text-left rounded-sm border transition-colors flex items-center space-x-2', 
                                    mode === m.id ? 'bg-[#e5f1fb] border-[#007acc] text-[#007acc] font-medium' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50']">
                        <span class="text-base">{{m.icon}}</span><span>{{m.name}}</span>
                    </button>
                </div>
            </div>

            <!-- Outline -->
            <div class="space-y-1.5 flex flex-col h-[280px]">
                <label class="font-semibold text-gray-700 uppercase tracking-widest text-[11px] flex justify-between">
                    <span>SOURCE.OUTLINE</span>
                    <span class="text-gray-400 font-normal">æ”¯æŒ Markdown / çº¯æ–‡æœ¬ç›´æ¥ç²˜è´´</span>
                </label>
                <textarea v-model="outline" 
                          class="flex-1 w-full border border-gray-300 rounded-sm px-3 py-2 bg-[#ffffff] focus:outline-none focus:border-[#007acc] focus:ring-1 focus:ring-[#007acc] transition-colors font-mono text-[12px] leading-relaxed shadow-inner" 
                          placeholder="æ— éœ€ç¹çæ‹†è§£ï¼Œè¯·å°†æ‚¨æ•°ç™¾ç”šè‡³æ˜¯ä¸Šåƒå­—çš„å®Œæ•´å°è¯´å¤§çº²ç›´æ¥é»è´´äºæ­¤ï¼Œæˆ‘ä»¬çš„å†…éƒ¨è§„åˆ’å™¨å°†ä¼šå…¨è‡ªåŠ¨å°†å…¶æ— ç¼å¯¹é½è‡³å„ä¸ªç« èŠ‚ã€‚"></textarea>
            </div>
            
            <!-- Global Settings -->
            <div class="space-y-1.5">
                <label class="font-semibold text-gray-700 uppercase tracking-widest text-[11px]">GLOBAL.SETTINGS (å¯é€‰)</label>
                <textarea v-model="settings" 
                          class="w-full border border-gray-300 rounded-sm px-3 py-2 bg-white focus:outline-none focus:border-[#007acc] focus:ring-1 focus:ring-[#007acc] transition-colors font-mono text-[12px] h-20" 
                          placeholder="å¡«å†™ä¸–ç•Œè§‚é¢„è®¾ã€‚å¦‚ï¼šè¿™æ˜¯ä¸€ä¸ªèµ›åšæœ‹å…‹ä¿®çœŸä¸–ç•Œï¼Œä¸»è§’æ€§æ ¼æåº¦è…¹é»‘ã€‚"></textarea>
            </div>

            <!-- Tweak Controls -->
            <div class="p-4 bg-white border border-gray-200 rounded-sm space-y-5">
                <!-- Target Words -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="font-semibold text-gray-700 uppercase tracking-widest text-[11px]">TARGET.WORDS</label>
                        <span class="text-[#007acc] font-mono font-bold">{{targetWords.toLocaleString()}} <span class="text-gray-400 font-normal text-xs">å­—</span></span>
                    </div>
                    <input type="range" v-model="targetWords" min="1000" max="20000" step="1000" class="w-full accent-[#007acc]">
                </div>
                
                <!-- Checker Toggle -->
                <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                    <label class="font-semibold text-gray-700 uppercase tracking-widest text-[11px] flex items-center" title="å¼€å¯å°†å¤§å¹…æå‡é€»è¾‘ä¸¥è°¨åº¦å¹¶åœ¨é˜²å´©åæ–¹é¢èµ·å†³å®šæ€§ä½œç”¨">
                        é€»è¾‘è‡ªæ£€å®¡è®¡å¼•æ“ (Checker)
                    </label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="enableCheck" class="sr-only peer">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[#007acc]"></div>
                    </label>
                </div>

                <!-- HITL Toggle -->
                <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                    <label class="font-semibold text-[#007acc] uppercase tracking-widest text-[11px] flex items-center" title="æ¯å†™å®Œä¸€ç« ï¼Œå¼¹å‡ºæ¥è®©ä½ ä¿®æ”¹å®šç¨¿ï¼Œç„¶åå†æ¨è¿›åç»­ç”Ÿæˆï¼Œç»ä¸å†™å´©ï¼">
                        äººæœºå…±åˆ›æ¨¡å¼ (é€ç« ä¿®æ”¹)
                    </label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="interactive" class="sr-only peer">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[#007acc]"></div>
                    </label>
                </div>
            </div>

        </div>

        <!-- Footer / Action Area -->
        <div class="p-4 border-t border-[#e5e7eb] bg-[#f8f9fa] shrink-0">
            <button @click="startGeneration" :disabled="isGenerating"
                    class="w-full flex items-center justify-center space-x-2 py-2.5 px-4 bg-[#007acc] hover:bg-[#005a9e] text-white rounded-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow">
                
                <svg v-if="isGenerating" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                
                <svg v-else class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                
                <span v-if="!isGenerating" class="tracking-widest uppercase text-xs">æ‰§è¡Œæ¸²æŸ“ç¼–è¯‘</span>
                <span v-else class="tracking-widest uppercase text-xs">å¼•æ“å…¨é€Ÿè¿è½¬ä¸­...</span>
            </button>
        </div>
    </div>

    <!-- ä¸»è¯•å›¾ (Main Layout - Editor View) -->
    <div class="flex-1 bg-white flex flex-col relative overflow-hidden">
        
        <!-- Tabs Header -->
        <div class="h-12 border-b border-[#e5e7eb] bg-[#f3f3f3] flex items-end px-2 space-x-1 shrink-0">
            <!-- Active Tab -->
            <div class="bg-white border text-[#333333] border-b-transparent border-[#e5e7eb] px-4 py-2 font-mono text-[11px] rounded-t-lg flex items-center z-10 -mb-[1px]">
                <span class="text-[#007acc] mr-2">{" "}</span> output.md
                <button v-if="finalContent" @click="copyContent" class="ml-4 hover:bg-gray-100 p-1 rounded transition text-gray-500 hover:text-[#007acc]" title="å¤åˆ¶ä»£ç ">
                    <svg fill="none" stroke="currentColor" class="w-3.5 h-3.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
            </div>
            <!-- Progress Status Tracker -->
            <div v-if="isGenerating" class="flex items-center text-[#007acc] font-mono text-[11px] px-4 py-2 mb-[1px] ml-auto animate-pulse max-w-lg truncate">
                <span class="w-2 h-2 rounded-full bg-[#007acc] mr-2"></span>
                <span>STATUS: {{currentProgress}}</span>
            </div>
        </div>

        <!-- Editor Content Space -->
        <div class="flex-1 overflow-x-hidden overflow-y-auto relative bg-white">
            
            <!-- Idle State. Empty watermark -->
            <div v-if="!isGenerating && !finalContent" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 pointer-events-none select-none">
                <img src="https://api.iconify.design/vscode-icons:file-type-markdown.svg" class="w-32 h-32 mb-6 opacity-20 grayscale" alt="Markdown Log">
                <h2 class="text-2xl font-light tracking-[0.2em] text-gray-300">WAITING FOR INPUT</h2>
                <p class="text-[13px] mt-2 tracking-wider">è¯·åœ¨å·¦ä¾§ä¸»æ§å°é…ç½®å¤§çº²å¹¶å¯åŠ¨å¼•æ“</p>
            </div>

            <!-- "Hacker Scanner" Terminal State (Generating) -->
            <div v-if="isGenerating" class="absolute inset-2 scanner-container shadow-inner flex overflow-hidden">
                <div class="scanner-laser"></div>
                <!-- Line Numbers -->
                <div class="w-12 bg-[#1e1e1e] border-r border-[#333333] pt-6 flex flex-col items-end pr-3 text-[#858585] font-mono text-[13px] leading-8 shrink-0 select-none">
                    <div v-for="n in 25" :key="n">{{n}}</div>
                </div>
                <!-- Terminal Output (Logs) -->
                <div class="flex-1 px-4 pt-6 pb-4 overflow-hidden flex flex-col border-l border-[#404040]">
                    <div class="flex-1"></div> <!-- Spacer to push text down to look like a console -->
                    <div class="flex flex-col space-y-2">
                        <div v-for="(line, idx) in scannerLines" :key="idx" 
                             class="text-[#d4d4d4] font-mono text-[13px] whitespace-nowrap overflow-hidden text-ellipsis transition-opacity duration-300" 
                             :class="{'text-[#4ec9b0] font-semibold pulse-text duration-100': idx === scannerLines.length - 1, 'opacity-40': idx < scannerLines.length - 4, 'opacity-70': idx >= scannerLines.length - 4 && idx < scannerLines.length - 1}">
                            <span class="text-[#569cd6]">sys</span><span class="text-[#cccccc]">.</span><span class="text-[#dcdcaa]">log</span><span class="text-[#cccccc]">(</span><span class="text-[#ce9178]">"{{line}}"</span><span class="text-[#cccccc]">);</span>
                        </div>
                        <div class="text-[#4ec9b0] font-mono text-[13px] mt-2 pulse-text relative before:content-['>_'] before:mr-2">
                            [[ {{currentProgress}} ]]
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finished Content (Markdown Body) -->
            <div v-if="!isGenerating && finalContent" class="p-10 max-w-4xl mx-auto">
                <div class="markdown-body" v-html="parsedContent"></div>
            </div>
            
        </div>
    </div>

    <!-- ğŸŒŸ HITL æ‚¬åœä¿®æ”¹å¼¹çª— (Modal) -->
    <div v-if="isPaused" class="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 transition-all">
        <div class="bg-white rounded shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden border border-gray-200">
            <!-- Modal Header -->
            <div class="h-14 bg-[#f8f9fa] border-b border-gray-200 flex items-center justify-between px-6 shrink-0">
                <h3 class="font-bold text-gray-800 flex items-center tracking-wide">
                    <span class="w-2.5 h-2.5 rounded-full bg-[#007acc] mr-3 animate-pulse"></span>
                    å¼•æ“æŒ‚èµ·ï¼šè¯·æ£€é˜…å¹¶é­”æ”¹å½“å‰ç« èŠ‚
                </h3>
                <span class="text-xs text-[#007acc] font-mono font-bold uppercase tracking-widest bg-blue-50 px-2 py-1 rounded">Status: PAUSED_FOR_REVIEW</span>
            </div>
            <!-- Modal Editor -->
            <div class="flex-1 p-0 overflow-hidden bg-[#fafafa]">
                <textarea v-model="pausedContent" class="w-full h-full p-8 font-mono text-[15px] leading-8 text-gray-800 focus:outline-none resize-none bg-transparent custom-scroll shadow-inner"></textarea>
            </div>
            <!-- Modal Actions -->
            <div class="h-16 bg-white border-t border-gray-200 flex items-center justify-end px-6 space-x-4 shrink-0">
                <span class="text-xs text-gray-400 mr-auto flex items-center">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    æ‚¨å¯ä»¥éšæ„ç¯¡æ”¹ä¸Šé¢çš„æ–‡æœ¬ï¼Œç‚¹å‡»å³ä¾§æŒ‰é’®åï¼Œå¤§æ¨¡å‹å°†åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­ç”Ÿé•¿åç»­å‰§æƒ…ã€‚
                </span>
                
                <button @click="resumeGeneration" :disabled="isResuming" class="px-6 py-2.5 bg-[#007acc] hover:bg-[#005a9e] text-white rounded-sm font-medium shadow transition-colors flex items-center justify-center min-w-[200px] tracking-widest text-sm">
                    <span v-if="!isResuming" class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> æ³¨å…¥é­”æ”¹å¹¶ç»§ç»­æ¨æ¼”</span>
                    <span v-else class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> æ•°æ®æ³¨å…¥ä¸­...
                    </span>
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            // å·¦ä¾§è¡¨å•æ•°æ®ç»‘å®š
            const title = ref("æ–°å»ºå²è¯—é•¿å·");
            const outline = ref("");
            const targetWords = ref(5000);
            const mode = ref("novel");
            const enableCheck = ref(true);
            const interactive = ref(true); // é»˜è®¤å¼€å¯äººæœºå…±åˆ›
            const settings = ref("");
            
            // æ¨¡å¼æ˜ å°„
            const modes = [
                { id: 'novel', name: 'å°è¯´å¼•æ“', icon: 'ğŸ“–' },
                { id: 'drama', name: 'çŸ­å‰§çˆ½æ–‡', icon: 'ğŸ¬' },
                { id: 'report', name: 'ä¸“ä¸šæŠ¥å‘Š', icon: 'ğŸ“Š' },
                { id: 'document', name: 'æŠ€æœ¯æ–‡æ¡£', icon: 'ğŸ’»' }
            ];

            // å¼•æ“çŠ¶æ€æ§åˆ¶
            const isGenerating = ref(false);
            const taskId = ref(null);
            const isPaused = ref(false);
            const isResuming = ref(false);
            const pausedContent = ref("");
            
            // è§†å›¾çŠ¶æ€
            const currentProgress = ref("");
            const finalContent = ref("");
            const parsedContent = computed(() => marked.parse(finalContent.value || ''));

            // ç‚«é…·æ‰«æåŠ¨ç”»æ—¥å¿—ç³»ç»Ÿ
            const scannerLines = ref([]);
            let scannerInterval = null;

            // å¤åˆ¶äº§ç‰©
            const copyContent = () => {
                navigator.clipboard.writeText(finalContent.value).then(() => {
                    alert('å…¨æ–‡å¤åˆ¶æˆåŠŸï¼');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥', err);
                    alert('ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œå¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰ã€‚');
                });
            }
            
            // å¯åŠ¨ç”Ÿæˆä¸»å…¥å£
            const startGeneration = async () => {
                if (!outline.value.trim()) {
                    alert("âš ï¸ è¯·åœ¨å·¦ä¾§ç²˜å…¥ä½ çš„å¤§çº²æ•°æ®ï¼");
                    return;
                }
                
                isGenerating.value = true;
                finalContent.value = "";
                currentProgress.value = "Establishing engine connection...";
                startScannerAnimation();

                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title.value,
                            outline: outline.value,
                            target_words: parseInt(targetWords.value),
                            mode: mode.value,
                            enable_check: enableCheck.value,
                            interactive: interactive.value,
                            settings: settings.value.trim() ? { world: settings.value } : null
                        })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.detail || JSON.stringify(data));
                    }
                    
                    taskId.value = data.task_id;
                    pollStatus();
                } catch (e) {
                    alert("åˆå§‹åŒ–ç”Ÿæˆè¯·æ±‚å¤±è´¥: " + e.message);
                    isGenerating.value = false;
                    clearInterval(scannerInterval);
                }
            };

            // çŠ¶æ€è½®è¯¢
            const pollStatus = async () => {
                if (!taskId.value) return;
                
                try {
                    const response = await fetch(`/api/task/${taskId.value}`);
                    const data = await response.json();
                    
                    currentProgress.value = data.progress || data.status;
                    pushScannerLog("ACK: " + currentProgress.value);
                    
                    if (data.status === 'completed') {
                        finishGeneration(data.content);
                    } else if (data.status === 'failed') {
                        throw new Error(data.error || "Unknown Failure");
                    } else if (data.status === 'paused') {
                        isPaused.value = true;
                        pausedContent.value = data.paused_content;
                        // æŒ‚èµ·æ—¶æš‚åœè½®è¯¢ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ç»§ç»­
                    } else {
                        // ç»§ç»­è½®è¯¢
                        setTimeout(pollStatus, 3000); 
                    }
                } catch(e) {
                    pushScannerLog("WARN: Polling hiccup, retrying... " + e.message);
                    console.error("Polling error", e);
                    setTimeout(pollStatus, 4000);
                }
            };

            // ç”Ÿæˆç»“æŸæ¸…ç†
            const finishGeneration = (content) => {
                isGenerating.value = false;
                isPaused.value = false;
                finalContent.value = content;
                clearInterval(scannerInterval);
            };

            // æ¢å¤ç”Ÿæˆ (HITL)
            const resumeGeneration = async () => {
                if (!pausedContent.value.trim()) return alert("ä¿®æ”¹å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
                isResuming.value = true;
                
                try {
                    const response = await fetch(`/api/task/${taskId.value}/continue`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            modified_content: pausedContent.value
                        })
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || "æ¢å¤å¤±è´¥");
                    }
                    
                    isPaused.value = false;
                    isResuming.value = false;
                    
                    pushScannerLog("SYS_OVERRIDE: User payload injected. Resuming...");
                    
                    // é‡å¯è½®è¯¢
                    pollStatus();
                } catch (e) {
                    alert('ç½‘ç»œé€šä¿¡å¼‚å¸¸ï¼š' + e.message);
                    isResuming.value = false;
                }
            };

            // æ§åˆ¶ç»ˆç«¯å¹½çµæ—¥å¿—æ»šåŠ¨åŠ¨ç”»
            const startScannerAnimation = () => {
                const dummyLogs = [
                    "Resolving global constraints matrix",
                    "Injecting structural character traits",
                    "Running forward predictive modeling (LLM)",
                    "Tree of Thought (ToT) evaluating branches...",
                    "Dropping bad branch / Resolving path",
                    "Inflating sliding window constraint",
                    "Parsing chapter sequence payload",
                    "Deep checking logic holes in vector space...",
                    "Writing narrative bytes to memory",
                    "Aligning context with worldview settings..."
                ];
                scannerLines.value = [];
                let dummyIndex = 0;
                
                if (scannerInterval) clearInterval(scannerInterval);
                scannerInterval = setInterval(() => {
                    const now = new Date();
                    const timestamp = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}.${String(now.getMilliseconds()).padStart(3,'0')}`;
                    pushScannerLog(`[${timestamp}] ${dummyLogs[dummyIndex % dummyLogs.length]}`);
                    dummyIndex++;
                }, 1200); // æ·»åŠ ä¸€ç‚¹éšæœºæ„Ÿçš„å‘¨æœŸ
            };

            const pushScannerLog = (msg) => {
                scannerLines.value.push(msg);
                if (scannerLines.value.length > 20) {
                    scannerLines.value.shift();
                }
            };

            return {
                title, outline, targetWords, mode, modes, enableCheck, interactive, settings,
                isGenerating, isPaused, isResuming, pausedContent, resumeGeneration,
                startGeneration, currentProgress, finalContent, parsedContent,
                scannerLines, copyContent
            };
        }
    }).mount('#app');
</script>

</body>
</html>
